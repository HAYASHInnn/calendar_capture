{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <h1 class="text-center mb-4">画像から日程を解析</h1>
        
        {% if error %}
            <div class="alert alert-danger">{{ error }}</div>
        {% endif %}

        <form method="post" enctype="multipart/form-data" id="uploadForm">
            <div class="upload-area" id="uploadArea">
                <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                <h4>日程が記載された画像をアップロード</h4>
                <p class="text-muted">ここにファイルをドラッグ&ドロップするか、クリックして選択してください</p>
                <input type="file" name="image" id="imageInput" accept="image/*" class="d-none" required>
                <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('imageInput').click()">
                    ファイルを選択
                </button>
            </div>
            
            <div id="preview" class="preview-container text-center" style="display: none;">
                <img id="previewImage" src="" alt="プレビュー" class="img-thumbnail">
            </div>
            
            <div class="text-center">
                <button type="submit" class="btn btn-primary btn-lg" id="analyzeBtn" disabled>
                    <span class="spinner-border spinner-border-sm d-none" id="spinner"></span>
                    解析開始
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const uploadArea = document.getElementById('uploadArea');
    const imageInput = document.getElementById('imageInput');
    const preview = document.getElementById('preview');
    const previewImage = document.getElementById('previewImage');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const uploadForm = document.getElementById('uploadForm');
    const spinner = document.getElementById('spinner');

    // ドラッグ&ドロップ
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            imageInput.files = files;
            showPreview(files[0]);
        }
    });

    // ファイル選択
    imageInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            showPreview(e.target.files[0]);
        }
    });

    // プレビュー表示
    function showPreview(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            previewImage.src = e.target.result;
            preview.style.display = 'block';
            analyzeBtn.disabled = false;
        };
        reader.readAsDataURL(file);
    }

    // フォーム送信
    uploadForm.addEventListener('submit', () => {
        analyzeBtn.disabled = true;
        spinner.classList.remove('d-none');
        analyzeBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 解析中...';
    });
</script>
{% endblock %}
